<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'" />

	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="css/index.css">

	<!-- Bootstrap -->
	<!--
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	-->
	<link rel="stylesheet" type="text/css" href="bootstrap-4.1.3-dist/css/bootstrap.min.css" />
	<script src="bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>

	<link rel="stylesheet" href="css/style.css">

	<script type="text/javascript" src="jquery.js"></script>

	<script type="text/javascript">
		//function for sorting deck. Usage: deckList = sortObj(decklist, 'grade')
		function sortObj(list, key) {
			function compare(a, b) {
				a = a[key];
				b = b[key];
				var type = (typeof (a) === 'string' ||
					typeof (b) === 'string') ? 'string' : 'number';
				var result;
				if (type === 'string') result = a.localeCompare(b);
				else result = a - b;
				return result;
			}
			return list.sort(compare);
		}

		//function for grouping cards, mainly by grade
		function groupBy(array, property) {
			var hash = {};
			for (var i = 0; i < array.length; i++) {
				if (!hash[array[i][property]]) hash[array[i][property]] = [];
				hash[array[i][property]].push(array[i]);
			}
			return hash;
		}

		//get user id from session
		var user_id = sessionStorage.getItem('user_id');
		user_id = parseInt(user_id);

		//get view deck info from session
		var viewdeck = sessionStorage.getItem('viewdeck');
		//alert(viewdeck);
		viewdeck = JSON.parse(viewdeck);

		//hold cards in deck
		var deckCards = [];

		$(document).ready(function () {
			//print deck name
			var platform;

			if (navigator.platform.match(/Win32|MacIntel/)) {
				platform = "http://127.0.0.1/";
			}
			else {
				platform = "http://10.0.2.2/";
			}

			document.getElementById("added-deck").innerHTML = viewdeck.deckname;

			var viewUserDeckUrl = platform + "zhang_kevin_project2/viewUserDeck.php";
			$.post(viewUserDeckUrl, { deck_id: viewdeck.deck_id }, function (data, textStatus) {
				//alert(JSON.stringify(data)); //for debugging
				var deck = data.deck;
				var cards = data.cards;

				//alert(JSON.stringify(deck));
				//alert(JSON.stringify(cards));

				//populate deck of cards
				$.each(cards, function (i, field) {

					var cards_id = field.cards_id;
					var name = field.name;
					var set = field.set;
					var imageFile = field.imageFile;
					// if image doesn't end in jpg, add jpg
					if (!imageFile.endsWith(".jpg")) {
						imageFile = imageFile + ".jpg";
					}
					var clan = field.clan;
					var grade = field.grade;
					var type = field.type;

					var imagePath = "vanguardImages/" + imageFile;
					var onErrorPath = "vanguardImages/cfv_back.jpg";

					var card = { cards_id: cards_id, name: name, set: set, imagePath: imagePath, clan: clan, grade: grade, type: type, onErrorPath: onErrorPath };
					deckCards.push(card);
				});

				// sort cards in deck
				var sortedCards = sortObj(deckCards, 'name');
				sortedCards = sortObj(deckCards, 'grade');

				// dictionary of card counts
				var cardDict = {};

				// print each card
				$.each(sortedCards, function (i, field) {
					//alert(JSON.stringify(field));
					$(".row").append(
						"<div class='cardinfo'>" +
						"<img src='" + field.imagePath + "' class='rounded' alt='" + field.name + "' onerror=this.src='" + field.onErrorPath + "' style='width:100%'>" +
						"<p>" +
						"<strong>Name: </strong>" + field.name + "<br>" +
						"<strong>Clan: </strong>" + field.clan + "<br>" +
						"<strong>Grade/Skill: </strong>" + field.grade + "<br>" +
						"</p>" +

						//remove card button
						"<div class='form-group'>" +
						"<button type='submit' name='remove-card-btn' id='remove-card-" + i + "' class='btn btn-primary btn-block btn-sm remove-card-btn'>Remove Card</button>" +
						"</div>" +

						"</div>");

					//initialize card count dictionary to 0 for each card
					cardDict[field.name] = 0;

					//append to decklist by grade
					/*if (field.grade.includes("0")) {
						$("#g0-list").append(
							"<li>" + field.name + "</li>"
						);
					}
					else if (field.grade.includes("1")) {
						$("#g1-list").append(
							"<li>" + field.name + "</li>"
						);
					}
					else if (field.grade.includes("2")) {
						$("#g2-list").append(
							"<li>" + field.name + "</li>"
						);
					}
					else if (field.grade.includes("3")) {
						$("#g3-list").append(
							"<li>" + field.name + "</li>"
						);
					}
					else if (field.grade.includes("4")) {
						$("#g4-list").append(
							"<li>" + field.name + "</li>"
						);
					}*/
				});

				var cardSet = [];

				// raise card counts
				$.each(sortedCards, function (i, field) {
					cardDict[field.name] += 1;
					//alert(JSON.stringify(field));
					if (!cardSet.includes(field.name)) {
						cardSet.push(field.name);
					}
				});

				// print decklist
				$.each(sortedCards, function (i, field) {
					// if in cardset, then add
					if (cardSet.includes(field.name)) {
						//append to decklist by grade
						if (field.grade.includes("0")) {
							$("#g0-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("1")) {
							$("#g1-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("2")) {
							$("#g2-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("3")) {
							$("#g3-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("4")) {
							$("#g4-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}

						//remove cardSet first element so if condition fails
						cardSet.shift();
					}
				});

				/*
				//hold cards sorted by grade
				var sortedGrades = [];

				// object of arrays, that sorts cards by grade
				var deckByGrade = groupBy(deckCards, 'grade');
				alert(JSON.stringify(deckByGrade));
				// iterate to get array of cards in each grade
				$.each(deckByGrade, function (i, field) {
					alert(JSON.stringify(field));
					var cardsByGrade = field;

					var sortedCardGrade = sortObj(cardsByGrade, 'name');
					sortedGrades.push(sortedCardGrade);
				});
				alert(JSON.stringify(sortedGrades)); //[[g4][g3][g2]]

				//reorganize grades
				*/
			}, "json");

			// command for the remove card button
			$(document).on("click", ".remove-card-btn", function () {
				var currentCardId = this.id;
				currentCardId = currentCardId[currentCardId.length - 1]; //get last character of array (the number)
				//convert id string to int
				currentCardId = parseInt(currentCardId);

				var cards_id = deckCards[currentCardId].cards_id;
				var deck_id = viewdeck.deck_id;
				var cardname = deckCards[currentCardId].name;

				//send number and card id to php w/ ajax post
				var removeCardsUrl = platform + "zhang_kevin_project2/removecards.php";
				$.post(removeCardsUrl, { cards_id: cards_id, deck_id: deck_id });

				//deckCards.splice(currentCardId, 1);
				location.href = "viewdeck.html";
				//document.getElementById("remove-cards").innerHTML = "Removed 1 copy of <strong>" + cardname + ".</strong>";

			});

			// command for the rate button
			$(document).on("click", "#rating-btn", function () {
				var rating = $("#rating :selected").val(); // The value of the selected option
				rating = parseInt(rating);

				var deck_id = viewdeck.deck_id;

				//post rating w/ ajax post
				var postRatingUrl = platform + "zhang_kevin_project2/postrating.php";
				$.post(postRatingUrl, { deck_id: deck_id, rating: rating, user_id: user_id }, function (data, textStatus) {
					document.getElementById("number-rating").style.display = "none";
					if (data === "rating already submitted") {
						document.getElementById("review-score").innerHTML = "You have already submitted a rating for this deck!";
					}
					else {
						document.getElementById("review-score").innerHTML = "Submitted " + rating + " star rating for " + viewdeck.deckname;
					}
				});
			});

			// command for show decklist button
			$(document).on("click", ".decklist-btn", function () {
				$(".decklist").toggle();
			});
		})
	</script>

	<title>View Decks</title>
</head>

<body>
	<header class="site-header">
		<div class="container">
			<h1>Vanguard Deck Builder</h1>
		</div>
	</header>

	<nav class="site-nav">
		<div class="container">
			<ul>
				<li><a href="browse.html">Browse Decks</a></li>
				<li><a href="build.html">Build Decks</a></li>
			</ul>
		</div>
	</nav>
	
	<section class="site-main">
		<div class="container">
			<!-- <p id="added-deck"></p> -->

			<h3 id="added-deck" class="text-center"></h3>

			<p class="text-center">Rate/Comment</p>
			<div class="form-group" id="number-rating">
				<select name='rating' id="rating" class="text-center">
					<option value='1'>1 (lowest)</option>
					<option value='2'>2</option>
					<option value='3'>3</option>
					<option value='4'>4</option>
					<option value='5'>5 (highest)</option>
				</select>
				<button type="submit" name="rating-btn" id="rating-btn" class="btn btn-primary btn-sm rating-btn">Post Rating</button>
			</div>
			<p id="review-score"></p>

			<button class="btn btn-primary btn-sm decklist-btn">Show Decklist</button>
			<div class="decklist nodisplay">
				<p>Grade 0:</p>
				<ul id="g0-list"></ul>
				<p>Grade 1:</p>
				<ul id="g1-list"></ul>
				<p>Grade 2:</p>
				<ul id="g2-list"></ul>
				<p>Grade 3:</p>
				<ul id="g3-list"></ul>
				<p>Grade 4:</p>
				<ul id="g4-list"></ul>
			</div>

			<div class="row">

			</div>

		</div>
	</section>

	<footer class="site-footer">

		
	</footer>

</body>

</html>