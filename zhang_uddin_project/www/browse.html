<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'" />

	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="css/index.css">

	<!-- Bootstrap -->
	<!--
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	-->
	<link rel="stylesheet" type="text/css" href="bootstrap-4.1.3-dist/css/bootstrap.min.css" />
	<script src="bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>

	<link rel="stylesheet" href="css/style.css">

	<script type="text/javascript" src="jquery.js"></script>

	<script type="text/javascript">
		//hold decks and ratings
		var allDecks = []; // list of user deck objects

		//function to get the image for a clan
		function getClanImageDirectory(clanName) {
			//remove spaces
			var clanNameStripped = clanName.split(' ').join('');
			var clanImageDir = "vanguardImages/clan/Icon_" + clanNameStripped + ".png";
			return clanImageDir;
		}

		//get user id from session
		var user_id = sessionStorage.getItem('user_id');
		user_id = parseInt(user_id);
		//if user id not set, return to login
		if (user_id === null || isNaN(user_id)) {
			location.href = "index.html";
		}

		//print each deck's info
		$(document).ready(function () {
			/*testing session variable
			var username = sessionStorage.getItem('username');
			alert(username);*/
			var platform;

			if (navigator.platform.match(/Win32|MacIntel/)) {
				platform = "http://127.0.0.1/";
			}
			else {
				platform = "http://10.0.2.2/";
			}

			$("#deck-search-btn").click(function () {
				//clear previous search results
				$('.row').html("");

				var deckname = $("#deckname").val();
				var clan = $("#clan").val();
				var creator = $("#creator").val();
				
				var url = platform + "zhang_kevin_project2/searchdecks.php";
				$.post(url, { deckname: deckname, clan: clan, creator: creator }, function (data, textStatus) {
					//alert(JSON.stringify(data)); //for debugging

					var decks = data.decks;
					var ratings = data.ratings;

					//clear any current card search results
					allDecks = [];
					//cardSearchResults.length = 0;

					//for each card, print info
					$.each(decks, function (i, field) {
						var deck_id = field.deck_id;
						var deckname = field.deckname;
						var description = field.description;
						// change description if empty
						if (description === "") {
							description = "N/A";
						}
						var creator = field.username;
						var clan = field.clan;
						var clanImageDir = getClanImageDirectory(clan);

						var rating = ratings[i].rating_average;
						// change rating if empty
						if (rating === "" || rating === null) {
							rating = "N/A";
						}
						else {
							rating = rating.toPrecision(2);
						}

						var deck = { deck_id: deck_id, deckname: deckname, description: description, clan: clan, rating: rating};
						//push each deck into deck array
						allDecks.push(deck);

						//add deckinfo boxes
						$(".row").append(
							"<div class='deckinfo'>" +
							"<img src='" + clanImageDir + "' class='rounded' alt='" + clan + "' style='width:100%'" +
							"<p>" +
							"<strong>Deck Name: </strong>" + deckname + "<br>" +
							"<strong>Clan: </strong>" + clan + "<br>" +
							"<strong>Creator: </strong>" + creator + "<br>" +
							"<strong>Rating (AVG): </strong>" + rating + "<br>" +
							"</p>" +

							//button to view deck
							"<div class='form-group'>" +
							"<button type='submit' name='view-deck-btn' id='view-deck-" + i + "' class='btn btn-primary btn-block btn-sm view-deck-btn'>View Deck</button>" +
							"</div>" +

							"</div>");
					});

				}, "json");
			})
		});

		// command for the view deck button
		// https://www.sitepoint.com/community/t/jquery-code-doesnt-work-on-dynamic-content-loaded-with-ajax/31758/5
		$(document).on("click", ".view-deck-btn", function () {
			//alert("Clicking on dynamic view button works");
			//check the id
			//alert(this.id);
			var currentDeckId = this.id;
			currentDeckId = currentDeckId[currentDeckId.length - 1]; //get last character of array (the number)
			//convert id string to int
			currentDeckId = parseInt(currentDeckId);

			//use id as index of userDeck array
			//alert("selected deck: " + JSON.stringify(userDecks[currentDeckId]));

			//save view deck info into session variables
			//alert(JSON.stringify(userDecks[currentDeckId]));
			sessionStorage.setItem('viewdeck', JSON.stringify(allDecks[currentDeckId]));

			location.href = "viewanydeck.html";
		});
	</script>

	<title>Browse Decks</title>
</head>

<body>
    <header class="site-header">
        <div class="container">
            <h1>Vanguard Deck Builder</h1>
        </div>
    </header>

    <!-- OLD NAV
        <nav class="site-nav">
        <div class="container">
            <ul>
                <li><a href="browse.html">Browse Decks</a></li>
                <li><a href="build.html">Build Decks</a></li>
                <li><a id="logout">Logout</a></li>
            </ul>
        </div>
    </nav>-->

    <div class="site-nav">
        <div id="sideMenu" class="sidemenu">
            <a href="javascript:void(0)" class="closebtn" onclick="closeSideMenu()">&times;</a>
            <a href="browse.html">Browse Decks</a>
            <a href="build.html">Build Decks</a>
            <a id="logout">Logout</a>
        </div>

        <span onclick="openSideMenu()" id="sideBarButton">&#9776</span>
    </div>

    <section class="site-main">
        <div class="container">
            <h3 class="text-center">All Decks</h3>

            <div class="form-group">
                <h6>Deck Name</h6>
                <input type="text" name="deckname" id="deckname" class="form-control form-control-sm">
            </div>
            <div class="form-group">
                <h6>Clan</h6>
                <select name='clan' id="clan">
                    <option value='%'>Any</option>
                    <option value='Angel Feather'>Angel Feather</option>
                    <option value='Aqua Force'>Aqua Force</option>
                    <option value='Bermuda Triangle'>Bermuda Triangle</option>
                    <option value='Dark Irregulars'>Dark Irregulars</option>
                    <option value='Dimension Police'>Dimension Police</option>
                    <option value='Gear Chronicle'>Gear Chronicle</option>
                    <option value='Genesis'>Genesis</option>
                    <option value='Gold Paladin'>Gold Paladin</option>
                    <option value='Granblue'>Granblue</option>
                    <option value='Great Nature'>Great Nature</option>
                    <option value='Kagero'>Kagero</option>
                    <option value='Link Joker'>Link Joker</option>
                    <option value='Megacolony'>Megacolony</option>
                    <option value='Murakumo'>Murakumo</option>
                    <option value='Narukami'>Narukami</option>
                    <option value='Neo Nectar'>Neo Nectar</option>
                    <option value='Nova Grappler'>Nova Grappler</option>
                    <option value='Nubatama'>Nubatama</option>
                    <option value='Oracle Think Tank'>Oracle Think Tank</option>
                    <option value='Pale Moon'>Pale Moon</option>
                    <option value='Royal Paladin'>Royal Paladin</option>
                    <option value='Shadow Paladin'>Shadow Paladin</option>
                    <option value='Spike Brothers'>Spike Brothers</option>
                    <option value='Tachikaze'>Tachikaze</option>
                </select>
            </div>
            <div class="form-group">
                <h6>Creator</h6>
                <input type="text" name="creator" id="creator" class="form-control form-control-sm">
            </div>
            <div class="form-group">
                <button type="submit" name="deck-search-btn" id="deck-search-btn" class="btn btn-primary btn-block btn-lg">Search Decks</button>
            </div>

            <div class="row">
                <!-- <div id="decks"></div> -->
            </div>
        </div>
    </section>

    <footer class="site-footer"></footer>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/platformOverrides.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>
</body>

</html>