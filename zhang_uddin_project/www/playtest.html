<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'" />

	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="css/index.css">

	<!-- Bootstrap -->
	<!--
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	-->
	<link rel="stylesheet" type="text/css" href="bootstrap-4.1.3-dist/css/bootstrap.min.css" />
	<script src="bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>

	<link rel="stylesheet" href="css/style.css">

	<script type="text/javascript" src="jquery.js"></script>

	<script type="text/javascript">
		//function to shuffle cards array
		function shuffle(array) {
			var currentIndex = array.length, temporaryValue, randomIndex;

			// While there remain elements to shuffle...
			while (0 !== currentIndex) {

				// Pick a remaining element...
				randomIndex = Math.floor(Math.random() * currentIndex);
				currentIndex -= 1;

				// And swap it with the current element.
				temporaryValue = array[currentIndex];
				array[currentIndex] = array[randomIndex];
				array[randomIndex] = temporaryValue;
			}

			return array;
		}

		function displayStartingHand(deck) {
			deckWithoutG4s = [];
			// remove grade 4 g units and g guardians
			$.each(deck, function (i, field) {
				//alert(JSON.stringify(field));

				grade = field.grade

				if (!grade.includes("Triple Drive") && !grade.includes("G-Guardian")) {
					deckWithoutG4s.push(field);
				}
			});
			//alert(JSON.stringify(deckWithoutG4s));

			//shuffle deck
			deckWithoutG4s = shuffle(deckWithoutG4s);

			// number of cards to print. Mainly handles if there are less than 5 cards
			numCardsToPrint = deckWithoutG4s.length;
			// if more than 5 cards, reduce to 5 cards
			if (numCardsToPrint > 5) {
				numCardsToPrint = 5;
			}

			//print first 5 cards
			for (i = 0; i < numCardsToPrint; i++) {
				//get image data
				var imageFile = deckWithoutG4s[i].imageFile;
				// if image doesn't end in jpg, add jpg
				if (!imageFile.endsWith(".jpg")) {
					imageFile = imageFile + ".jpg";
				}

				var name = deckWithoutG4s[i].name;

				var imagePath = "vanguardImages/" + imageFile;
				var onErrorPath = "vanguardImages/cfv_back.jpg";

				var serverImageSource = platform + "zhang_kevin_project2/" + imagePath;
				//print cards
				$(".row").append(
					"<div class='cardinfo'>" +
					"<img src='" + serverImageSource + "' id='card-image-" + i + "' class='card-image rounded' onerror=this.src='" + onErrorPath + "' style='width:100%'>" +

					//modal div
					"<div id= 'card-modal-" + i + "' class='modal' >" +
					"<span class='close'>&times;</span>" +
					"<img id='modal-image-" + i + "' class='modal-content'>" +
					"</div>" +

					"<p style='text-align:center;'>" + name + "</p>" +

					"</div>");
			}
		}

		// platform info
		var platform;

		if (navigator.platform.match(/Win32|MacIntel/)) {
			platform = "http://127.0.0.1/";
		}
		else {
			platform = "http://10.0.2.2/";
		}

		//SESSION VARIABLES

		//get user id from session
		var user_id = sessionStorage.getItem('user_id');
		user_id = parseInt(user_id);

		//get view deck info from session
		var viewdeck = sessionStorage.getItem('viewdeck');
		//alert(viewdeck);
		viewdeck = JSON.parse(viewdeck);

		//get view deck cards info from session
		var viewdeckcards = sessionStorage.getItem('viewdeckcards');
		//alert(viewdeck);
		viewdeckcards = JSON.parse(viewdeckcards);

		//get user id from session
		var user_id = sessionStorage.getItem('user_id');
		user_id = parseInt(user_id);
		//if user id not set, return to login
		if (user_id === null || isNaN(user_id)) {
			location.href = "index.html";
		}

		$(document).ready(function () {
			document.getElementById("added-deck").innerHTML = "Starting hand (excluding red & green G-Units) for: " + viewdeck.deckname;

			displayStartingHand(viewdeckcards);
		})

		// command for draw cards button
		$(document).on("click", ".playtest-btn", function () {
			// clear previous starting hand
			$(".row").empty();

			//draw another hand
			displayStartingHand(viewdeckcards);
		});

		//save the current modal globally, so it can be used in close
		var currentModal = null;

		// command for clicking on image
		$(document).on("click", ".card-image", function () {
			//alert("Card clicked!");
			var currentCardId = this.id;
			currentCardId = currentCardId.split('-')[2]; //get last number in id
			//convert id string to int
			currentCardId = parseInt(currentCardId);

			// get card ids
			var cardImageId = "card-image-" + currentCardId;
			var cardModalId = "card-modal-" + currentCardId;
			var modalImageId = "modal-image-" + currentCardId;

			// get modal
			var modal = document.getElementById(cardModalId);

			//insert image into modal 
			//FIXME: refactor cardImage to use ajax post that gets big image from server
			var cardImage = document.getElementById(cardImageId);

			// prepare card info for server request
			var cardName = this.alt;
			var cardImageSource = this.src;
			// get last part of source, which is the file name
			var sourceParts = cardImageSource.split('/');
			var cardFileName = sourceParts.pop() || sourceParts.pop();

			// get larger image from server
			var serverImageSource = platform + "zhang_kevin_project2/vanguardImages/" + cardFileName;
			var serverCardId = "server-card-" + currentCardId;

			var modalImage = document.getElementById(modalImageId);
			modal.style.display = "block";
			modalImage.src = serverImageSource;
			modalImage.alt = cardName;

			currentModal = modal;
		});

		$(document).on("click", ".close", function () {
			var modal = currentModal;
			modal.style.display = "none";
		});

		// command for detecting shake
		/*shake.startWatch(onShake, onError);
		
		var onShake = function () {
			// Fired when a shake is detected
			// clear previous starting hand
            $(".row").empty();

            alert("Shaking the phone");

			//draw another hand
			displayStartingHand(viewdeckcards);
		};*/

        document.addEventListener("deviceready", onDeviceReady, false);

        function onDeviceReady()
        {
            alert("device ready");
            var currentx;
            var currenty;
            var watchID2;
            var watchID3;

            navigator.accelerometer.getCurrentAcceleration(onLoad, onErrorLoad);
            document.getElementById("getAcceleration").addEventListener("click", getAcceleration);
            document.getElementById("watchAcceleration").addEventListener("click", watchAcceleration);
            function getAcceleration() {
                navigator.accelerometer.getCurrentAcceleration(
                    accelerometerSuccess, accelerometerError);

                function accelerometerSuccess(acceleration) {
                    alert('Acceleration X: ' + acceleration.x + '\n' +
                        'Acceleration Y: ' + acceleration.y + '\n' +
                        'Acceleration Z: ' + acceleration.z + '\n' +
                        'Timestamp: ' + acceleration.timestamp + '\n');
                };

                function accelerometerError() {
                    alert('onError!');
                };
            }

            function watchAcceleration() {
                alert("finish");

            }

            var accelerometerOptions2 = {
                frequency: 200
            }

            var accelerometerOptions = {
                frequency: 500
            }
            var watchID = navigator.accelerometer.watchAcceleration(
                accelerometerSuccess, accelerometerError, accelerometerOptions);

            function accelerometerSuccess(acceleration) {
                if (acceleration.x >= 6 || acceleration.y >= 6 || acceleration.x <= -6 || acceleration.y <= -6) {
                    currentx = acceleration.x;
                    currenty = acceleration.y;

                    watchID2 = navigator.accelerometer.watchAcceleration(
                        accelerometerSuccess2, accelerometerError, accelerometerOptions2);
                }
            };

            function accelerometerSuccess2(acceleration) {
                if (acceleration.x < currentx || acceleration.y < currenty) {
                    currentx = acceleration.x;
                    currenty = acceleration.y;

                    watchID3 = navigator.accelerometer.watchAcceleration(
                        accelerometerSuccess3, accelerometerError, accelerometerOptions2);

                }

                setTimeout(function () {
                    navigator.accelerometer.clearWatch(watchID2);
                }, 1000);
            };

            function accelerometerSuccess3(acceleration) {
                if (acceleration.x > currentx || acceleration.y > currenty) {
                    currentx = acceleration.x;
                    currenty = acceleration.y;

                    $(".row").empty();
                    displayStartingHand(viewdeckcards);
                }

                setTimeout(function () {
                    navigator.accelerometer.clearWatch(watchID3);
                }, 1000);
            };

            function accelerometerError() {
                alert('onError!');
            };

            function onLoad(acceleration)
            {
                currentx = acceleration.x;
                currenty = acceleration.y;
            }

            function onErrorLoad()
            {
                alert("error");
                currentx = 0;
                currenty = 0;
            }
        }

	</script>

	<title>View Decks</title>
</head>

<body>
    <header class="site-header">
        <div class="container">
            <h1>Vanguard Deck Builder</h1>
        </div>
    </header>

    <!-- OLD NAV
        <nav class="site-nav">
        <div class="container">
            <ul>
                <li><a href="browse.html">Browse Decks</a></li>
                <li><a href="build.html">Build Decks</a></li>
                <li><a id="logout">Logout</a></li>
            </ul>
        </div>
    </nav>-->

    <div class="site-nav">
        <div id="sideMenu" class="sidemenu">
            <a href="javascript:void(0)" class="closebtn" onclick="closeSideMenu()">&times;</a>
            <a href="browse.html">Browse Decks</a>
            <a href="build.html">Build Decks</a>
            <a id="logout">Logout</a>
        </div>

        <span onclick="openSideMenu()" id="sideBarButton">&#9776</span>
    </div>

    <section class="site-main">
        <div class="container">
            <!-- <p id="added-deck"></p> -->

            <h3 id="playtest-title" class="text-center">Playtest</h3>

            <hr />


            <p id="added-deck"></p>

            <button class="btn btn-primary btn-sm playtest-btn">Draw Another Hand</button>

            <hr />

            <div class="row">

            </div>

        </div>
        <button id="getAcceleration">GET ACCELERATION</button>
        <button id="watchAcceleration">WATCH ACCELERATION</button>
    </section>

    <footer class="site-footer"></footer>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/platformOverrides.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>

</body>

</html>