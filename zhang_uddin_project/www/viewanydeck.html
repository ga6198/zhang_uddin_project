<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">

	<meta http-equiv="Content-Security-Policy" content="default-src *; style-src 'self' http://* 'unsafe-inline'; script-src 'self' http://* 'unsafe-inline' 'unsafe-eval'" />

	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<meta name="format-detection" content="telephone=no">
	<meta name="msapplication-tap-highlight" content="no">
	<meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
	<link rel="stylesheet" type="text/css" href="css/index.css">

	<!-- Bootstrap -->
	<!--
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	-->
	<link rel="stylesheet" type="text/css" href="bootstrap-4.1.3-dist/css/bootstrap.min.css" />
	<script src="bootstrap-4.1.3-dist/js/bootstrap.min.js"></script>

	<link rel="stylesheet" href="css/style.css">

	<script type="text/javascript" src="jquery.js"></script>

	<script type="text/javascript">
		//function for sorting deck. Usage: deckList = sortObj(decklist, 'grade')
		function sortObj(list, key) {
			function compare(a, b) {
				a = a[key];
				b = b[key];
				var type = (typeof (a) === 'string' ||
					typeof (b) === 'string') ? 'string' : 'number';
				var result;
				if (type === 'string') result = a.localeCompare(b);
				else result = a - b;
				return result;
			}
			return list.sort(compare);
		}

		//function for grouping cards, mainly by grade
		function groupBy(array, property) {
			var hash = {};
			for (var i = 0; i < array.length; i++) {
				if (!hash[array[i][property]]) hash[array[i][property]] = [];
				hash[array[i][property]].push(array[i]);
			}
			return hash;
		}

		//get user id from session
		var user_id = sessionStorage.getItem('user_id');
		user_id = parseInt(user_id);

		//get view deck info from session
		var viewdeck = sessionStorage.getItem('viewdeck');
		//alert(viewdeck);
		viewdeck = JSON.parse(viewdeck);

		//get user id from session
		var user_id = sessionStorage.getItem('user_id');
		user_id = parseInt(user_id);
		//if user id not set, return to login
		if (user_id === null || isNaN(user_id)) {
			location.href = "index.html";
		}

		//hold cards in deck
		var deckCards = [];

		$(document).ready(function () {
			//print deck name
			var platform;

			if (navigator.platform.match(/Win32|MacIntel/)) {
				platform = "http://127.0.0.1/";
			}
			else {
				platform = "http://10.0.2.2/";
			}

			document.getElementById("added-deck").innerHTML = viewdeck.deckname;
			document.getElementById("desc").innerHTML = viewdeck.description;

			var viewUserDeckUrl = platform + "zhang_kevin_project2/viewUserDeck.php";
			$.post(viewUserDeckUrl, { deck_id: viewdeck.deck_id }, function (data, textStatus) {
				//alert(JSON.stringify(data)); //for debugging
				var deck = data.deck;
				var cards = data.cards;

				//alert(JSON.stringify(deck));
				//alert(JSON.stringify(cards));

				//save current cards to session
				sessionStorage.setItem('viewdeckcards', JSON.stringify(cards));

				//populate deck of cards
				$.each(cards, function (i, field) {

					var cards_id = field.cards_id;
					var name = field.name;
					var set = field.set;
					var imageFile = field.imageFile;
					// if image doesn't end in jpg, add jpg
					if (!imageFile.endsWith(".jpg")) {
						imageFile = imageFile + ".jpg";
					}
					var clan = field.clan;
					var grade = field.grade;
					var type = field.type;

					var imagePath = "vanguardImages/" + imageFile;
					var onErrorPath = "vanguardImages/cfv_back.jpg";

					var card = { cards_id: cards_id, name: name, set: set, imagePath: imagePath, clan: clan, grade: grade, type: type, onErrorPath: onErrorPath };
					deckCards.push(card);
				});

				// sort cards in deck
				var sortedCards = sortObj(deckCards, 'name');
				sortedCards = sortObj(deckCards, 'grade');

				// dictionary of card counts
				var cardDict = {};

				// print each card
				$.each(sortedCards, function (i, field) {
					//alert(JSON.stringify(field));
					$(".row").append(
						"<div class='cardinfo'>" +
						"<img src='" + field.imagePath + "' id='card-image-" + i + "' class='card-image rounded' alt='" + field.name + "' onerror=this.src='" + field.onErrorPath + "' style='width:100%'>" +

						//modal div
						"<div id= 'card-modal-" + i + "' class='modal' >" +
						"<span class='close'>&times;</span>" +
						"<img id='modal-image-" + i + "' class='modal-content'>" +
						"</div>" +

						"<p>" +
						"<strong>Name: </strong>" + field.name + "<br>" +
						"<strong>Clan: </strong>" + field.clan + "<br>" +
						"<strong>Grade/Skill: </strong>" + field.grade + "<br>" +
						"</p>" +

						"</div>");

					//initialize card count dictionary to 0 for each card
					cardDict[field.name] = 0;
				});

				var cardSet = [];

				// raise card counts
				$.each(sortedCards, function (i, field) {
					cardDict[field.name] += 1;
					//alert(JSON.stringify(field));
					if (!cardSet.includes(field.name)) {
						cardSet.push(field.name);
					}
				});

				// print decklist
				$.each(sortedCards, function (i, field) {
					// if in cardset, then add
					if (cardSet.includes(field.name)) {
						//append to decklist by grade
						if (field.grade.includes("0")) {
							$("#g0-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("1")) {
							$("#g1-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("2")) {
							$("#g2-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("3")) {
							$("#g3-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}
						else if (field.grade.includes("4")) {
							$("#g4-list").append(
								"<li>" + cardDict[field.name] + "x " + field.name + "</li>"
							);
						}

						//remove cardSet first element so if condition fails
						cardSet.shift();
					}
				});
			}, "json");

			// command for the rate button
			$(document).on("click", "#rating-btn", function () {
				var rating = $("#rating :selected").val(); // The value of the selected option
				rating = parseInt(rating);

				var deck_id = viewdeck.deck_id;

				//post rating w/ ajax post
				var postRatingUrl = platform + "zhang_kevin_project2/postrating.php";
				$.post(postRatingUrl, { deck_id: deck_id, rating: rating, user_id: user_id }, function (data, textStatus) {
					document.getElementById("number-rating").style.display = "none";
					if (data === "rating already submitted") {
						document.getElementById("review-score").innerHTML = "You have already submitted a rating for this deck!";
					}
					else {
						document.getElementById("review-score").innerHTML = "Submitted " + rating + " star rating for " + viewdeck.deckname;
					}
				});
			});

			// command for show decklist button
			$(document).on("click", ".decklist-btn", function () {
				$(".decklist").toggle();
			});

			// command for playtest/draw cards button
			$(document).on("click", ".playtest-btn", function () {
				location.href = "playtest.html";
			});

			//save the current modal globally, so it can be used in close
			var currentModal = null;

			// command for clicking on image
			$(document).on("click", ".card-image", function () {
				//alert("Card clicked!");
				var currentCardId = this.id;
				currentCardId = currentCardId.split('-')[2]; //get last number in id
				//convert id string to int
				currentCardId = parseInt(currentCardId);

				// get card ids
				var cardImageId = "card-image-" + currentCardId;
				var cardModalId = "card-modal-" + currentCardId;
				var modalImageId = "modal-image-" + currentCardId;

				// get modal
				var modal = document.getElementById(cardModalId);

				//insert image into modal 
				//FIXME: refactor cardImage to use ajax post that gets big image from server
				var cardImage = document.getElementById(cardImageId);

				// prepare card info for server request
				var cardName = this.alt;
				var cardImageSource = this.src;
				// get last part of source, which is the file name
				var sourceParts = cardImageSource.split('/');
				var cardFileName = sourceParts.pop() || sourceParts.pop();

				// get larger image from server
				var serverImageSource = platform + "zhang_kevin_project2/vanguardImages/" + cardFileName;
				var serverCardId = "server-card-" + currentCardId;

				var modalImage = document.getElementById(modalImageId);
				modal.style.display = "block";
				modalImage.src = serverImageSource;
				modalImage.alt = cardName;

				currentModal = modal;
			});

			$(document).on("click", ".close", function () {
				var modal = currentModal;
				modal.style.display = "none";
			});
		})
	</script>

	<title>View Decks</title>
</head>

<body>
    <header class="site-header">
        <div class="container">
            <h1>Vanguard Deck Builder</h1>
        </div>
    </header>

    <!-- OLD NAV
        <nav class="site-nav">
        <div class="container">
            <ul>
                <li><a href="browse.html">Browse Decks</a></li>
                <li><a href="build.html">Build Decks</a></li>
                <li><a id="logout">Logout</a></li>
            </ul>
        </div>
    </nav>-->

    <div class="site-nav">
        <div id="sideMenu" class="sidemenu">
            <a href="javascript:void(0)" class="closebtn" onclick="closeSideMenu()">&times;</a>
            <a href="browse.html">Browse Decks</a>
            <a href="build.html">Build Decks</a>
            <a id="logout">Logout</a>
        </div>

        <span onclick="openSideMenu()" id="sideBarButton">&#9776</span>
    </div>

    <section class="site-main">
        <div class="container">
            <!-- <p id="added-deck"></p> -->

            <h3 id="added-deck" class="text-center"></h3>

            <hr />

            Description: <p id="desc"></p>

            <hr />

            <p class="text-center">Rate/Comment</p>
            <div class="form-group" id="number-rating">
                <select name='rating' id="rating" class="text-center">
                    <option value='1'>1 (lowest)</option>
                    <option value='2'>2</option>
                    <option value='3'>3</option>
                    <option value='4'>4</option>
                    <option value='5'>5 (highest)</option>
                </select>
                <button type="submit" name="rating-btn" id="rating-btn" class="btn btn-primary btn-sm rating-btn">Post Rating</button>
            </div>
            <p id="review-score"></p>

            <hr />

            <button class="btn btn-primary btn-sm decklist-btn">Show Decklist</button>
            <div class="decklist nodisplay">
                <p>Grade 0:</p>
                <ul id="g0-list"></ul>
                <p>Grade 1:</p>
                <ul id="g1-list"></ul>
                <p>Grade 2:</p>
                <ul id="g2-list"></ul>
                <p>Grade 3:</p>
                <ul id="g3-list"></ul>
                <p>Grade 4:</p>
                <ul id="g4-list"></ul>
            </div>

            <button class="btn btn-primary btn-sm playtest-btn">Draw Starting Hand</button>

            <hr />

            <div class="row">

            </div>

        </div>
    </section>

    <footer class="site-footer"></footer>

    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="scripts/platformOverrides.js"></script>
    <script type="text/javascript" src="scripts/index.js"></script>

</body>

</html>